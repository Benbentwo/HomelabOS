---
version: '3'

networks:
  traefik_network:
    external:
      name: homelabos_traefik

services:

  growdash:
    restart: always
    environment:
        - DEV
        - FACILITY_NAME
        - FACILITY_ID
        - CERES
        - DEMO
        - ENVIRONMENT
        - REMOTE_URL
        - VERSION
        - SHORT_NAME

        - SET_POINT_ALARM_TOLERANCE_PERCENTAGE
        - BURNOUT_PROTECTION_DELAY

        - DB_HOSTNAME
        - MYSQL_ROOT_PASSWORD
        - MYSQL_DATABASE
        - MYSQL_TEST_DATABASE
        - MYSQL_USER
        - MYSQL_PASSWORD

        - REDIS_HOSTNAME
        - RABBIT_HOST
        - RABBIT_PORT
        - RABBIT_USER
        - RABBIT_PASS
        - INFLUX_HOST
        - INFLUX_PORT
        
        - SMTP_HOST
        - SMTP_USER
        - SMTP_PASS
    image: grownetics/growdash:${VERSION}
    volumes:
        - ./html:/var/www/html:cached
        - ./tmp:/tmp:cached

  deviceapi:
    restart: always
    links:
        - appdb
        - redis
        - rabbitmq
    environment:
        - DEV
        - FACILITY_NAME
        - FACILITY_ID
        - CERES
        - ENVIRONMENT
        - REMOTE_URL
        - VERSION
        - SHORT_NAME

        - SET_POINT_ALARM_TOLERANCE_PERCENTAGE
        - BURNOUT_PROTECTION_DELAY

        - DB_HOSTNAME
        - MYSQL_ROOT_PASSWORD
        - MYSQL_DATABASE
        - MYSQL_TEST_DATABASE
        - MYSQL_USER
        - MYSQL_PASSWORD

        - REDIS_HOSTNAME
        - RABBIT_HOST
        - RABBIT_PORT
        - RABBIT_USER
        - RABBIT_PASS
        - INFLUX_HOST
        - INFLUX_PORT
    image: grownetics/growdash:${VERSION}
    volumes:
        - ./html:/var/www/html:cached
        - ./tmp:/tmp:cached

  nginx:
    image: grownetics/nginx:${VERSION}
    networks:
        - traefik_network
    volumes:
        - ./html:/var/www/html
        - ./html/images/nginx/:/var/www/templates
        - ./html/images/nginx/conf.d/growdash.dashonly.conf:/etc/nginx/conf.d/default.conf
    restart: always
    labels:
        - "traefik.enable=true"
        - "traefik.docker.network=homelabos_traefik"
        - "traefik.http.services.grownetics.loadbalancer.server.scheme=http"
        - "traefik.http.services.grownetics.loadbalancer.server.port=8080"
        - "traefik.http.routers.grownetics-http.rule=Host(`grownetics.{{ domain }}`)"
        - "traefik.http.routers.grownetics-http.entrypoints=http"
        - "traefik.http.routers.grownetics-http.middlewares={% if grownetics.https_only %}redirect@file, {% else %}{% if grownetics.auth %}{% if enable_authelia %}authelia@file{% else %}basicAuth@file{% endif %}, {% endif %}{% endif %}customFrameHomelab@file"
        - "traefik.http.routers.grownetics.rule=Host(`grownetics.{{ domain }}`)"
        - "traefik.http.routers.grownetics.entrypoints=https"
        - "traefik.http.routers.grownetics.middlewares={% if grownetics.auth %}{% if enable_authelia %}authelia@file{% else %}basicAuth@file{% endif %}, {% endif %}customFrameHomelab@file"
        - "traefik.http.routers.grownetics.tls=true"
        - "traefik.http.routers.grownetics.tls.domains[0].main={{ domain }}"
        - "traefik.http.routers.grownetics.tls.domains[0].sans=*.{{ domain }}"
    {% if traefik.dns_challenge_provider %}
        - "traefik.http.routers.grownetics.tls.certresolver=dns"
    {% else %}
        - "traefik.http.routers.grownetics.tls.certresolver=http"
    {% endif %}
    {% if enable_tor %}
        - "traefik.tor.frontend.rule=Host:grownetics.{{ tor_domain }}"
        - "traefik.tor.protocol=http"
        - "traefik.tor.port=80"
    {% endif %}

  appdb:
    image: mariadb #:10.3
    restart: always
    command: mysqld --sql_mode=""
    environment:
        - MYSQL_ROOT_PASSWORD
        - MYSQL_DATABASE
        - MYSQL_TEST_DATABASE
        - MYSQL_USER
        - MYSQL_PASSWORD
    volumes:
        - ./data/appdb:/var/lib/mysql
    ports:
        - "3306:3306"

  redis:
    image: redis
    restart: always

  growsocket:
    image: grownetics/socketio:latest
    restart: always
    ports:
        - "8989:8989"
    volumes:
        - ./html/images/socketio/socket.js:/srv/socket.js
    links:
        - rabbitmq
        - nginx
    labels:
        io.rancher.container.pull_image: always
        io.rancher.scheduler.affinity:host_label_ne: onsite=true

  rabbitmq:
    image: rabbitmq:3.6-management-alpine
    restart: always
    environment:
        # - RABBITMQ_DEFAULT_USER:RABBIT_USER
        - RABBITMQ_DEFAULT_USER=rabbit
        # - RABBITMQ_DEFAULT_PASS:RABBIT_PASS
        - RABBITMQ_DEFAULT_PASS=rabbit
    ports:
        - "15672:15672"
        - "5672:5672"


