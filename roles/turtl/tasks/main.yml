---
- name: Make turtl directory.
  file:
    path: "{{ volumes_root }}/turtl"
    state: directory

- name: Check out Turtl server git repo
  git:
    repo: https://github.com/turtl/server.git
    dest: "{{ volumes_root }}/turtl/server"

- name: Copy turtl docker-compose.yml file into place.
  template:
    src: docker-compose.turtl.yml.j2
    dest: "{{ volumes_root }}/turtl/docker-compose.turtl.yml"
  vars:
    tor_domain: "{{ tor_http_domain_file.stdout | default('') }}"

- name: Build project from docker-compose
  docker_compose:
    project_src: "{{ volumes_root }}/turtl"
    files:
      - docker-compose.turtl.yml
    build: yes

- name: Start database to create user and empty database. Turtl is not resilient for waiting by itself.
  docker_compose:
    project_src: "{{ volumes_root }}/turtl"
    files:
      - docker-compose.turtl.yml
    services:
      - postgres-db
    state: present

- pause:
    seconds: 20

#- name: Delete the Turtl Git checkout from the volume_root
#  file:
#    path: "{{ volumes_root }}/turtl/server"
#    state: absent

- name: Configure turtl systemd service.
  template:
    src: service.j2
    dest: /etc/systemd/system/turtl.service

- name: Start turtl
  systemd:
    name: turtl
    enabled: "yes"
    daemon-reload: "yes"
    state: started
