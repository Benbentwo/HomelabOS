---
- name: Make HomelabOS data directory.
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - /var/homelabos
    - /var/homelabos/apple_health_influx
    - /var/homelabos/dasher
    - /var/homelabos/docker
    - /var/homelabos/telegraf
    - /var/homelabos/traefik
    - /mnt/nas

- name: Configure Telegraf.
  template: src=telegraf.conf dest=/var/homelabos/telegraf/telegraf.conf

- name: Configure Traefik.
  template: src=traefik.toml dest=/var/homelabos/traefik/traefik.toml

- name: Configure Dasher
  template: src=dasher.config.json dest=/var/homelabos/dasher/config.json

- name: Configure Apple Health Importer
  template: src=apple_health_config.yml dest=/var/homelabos/apple_health_influx/config.yml

  - name: Configure NAS
  lineinfile:
    path: /etc/fstab
    line: '{{ nas_path }}  /mnt/nas  cifs  username={{ nas_user }},vers=2.0,dom={{ nas_workgroup }},password={{ nas_pass }},uid=1000,iocharset=utf8  0  0'

- name: Mount NAS Drives
  command: mount -a
  args:
    warn: no
  ignore_errors: yes

- name: Configure HomelabOS systemd service.
  template: src=homelabos.service dest=/etc/systemd/system/homelabos.service

- name: Copy HomelabOS docker-compose.yml file into place.
  template:
    src: docker-compose.yml
    dest: /var/homelabos/docker/docker-compose.yml

# This breaks with Vagrant and seems unreliable. Let's find a better solution.
# - name: Create HomelabOS hosts file.
#   file:
#     path: /tmp/homelab_hosts
#     state: touch
#   delegate_to: localhost
#
# - name: Configure HomelabOS hosts file. You can find it at /tmp/homelabos_hosts on your machine.
#   lineinfile:
#     path: /tmp/homelab_hosts
#     line: '{{ ansible_host }} {{ item }}.{{ domain }} {{ item }}'
#   delegate_to: localhost
#   loop:
#     - irc
#     - emby
#     - money
#     - grafana
#     - homeassistant
#     - nextcloud
#     - paperless
#     - portainer
#     - terminal
#     - transmission
#     - music
#     - git

- name: Pull latest HomelabOS service docker images. (This could take a while the first time, it has to download quite a bit.)
  command: docker-compose -f /var/homelabos/docker/docker-compose.yml pull

- name: Restart HomelabOS service.
  systemd:
    name: homelabos
    enabled: yes
    daemon-reload: yes
    state: restarted

- debug:
    msg: "HomelabOS Installed successfully! Go to https://{{ domain }}/ to get started."

- debug:
    msg: "Problems? File an issue at https://gitlab.com/NickBusey/HomelabOS/issues"