# Commented out services are in beta testing and not integrated or documented yet. Uncomment them at your own peril.

version: '3'

services:
  # Apple Health Data Importer
  apple_health_influx:
    image: nickbusey/healthdata_influx:cron
    restart: always
    volumes:
      - /var/homelabos/nextcloud/data/{{ apple_health_nextcloud_username }}/files/export/:/export/
      - /var/homelabos/apple_health_influx/config.yml:/config.yml

  # Password Manager
  bitwarden_web:
    image: mprasil/bitwarden
    restart: always
    volumes:
      - /var/homelabos/bitwarden:/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:warden.{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=80"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM http://{{ domain }}"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM https://{{ domain }}"
      - "traefik.tor.frontend.rule=Host:warden.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=80"

  # Weather Data Importer
  darksky-influx:
    image: erwinsteffens/darksky-influxdb:latest
    restart: always
    links:
      - influxdb
    environment:
      - DARKSKY_KEY={{ darksky_key }}
      # This is every 2 minutes. This is about as fast as you can go with the free API keys without running out of queries.
      - CRON=0 */2 * * * *
      - INFLUXDB_HOST=influxdb
      - INFLUXDB_DATABASE=darksky
      - DARKSKY_LATITUDE={{ latitude }}
      - DARKSKY_LONGITUDE={{ longitude }}

  # Amazon Dash Button
  dasher:
    image: hijinx/dasher
    restart: always
    network_mode: host
    volumes:
      - /var/homelabos/dasher/config.json:/usr/src/app/config/config.json

  # HomelabOS Documentation
  docs:
    image: kyma/docker-nginx
    restart: always
    volumes:
      - /var/homelabos/docs/site:/var/www
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:docs.{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=80"
      - "traefik.tor.frontend.rule=Host:docs.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=80"

  # Media Server
  emby:
    image: emby/embyserver:latest
    restart: always
    volumes:
      - /var/homelabos/emby:/config
      - /mnt/nas:/mnt/nas
      - /mnt/nas/tmp:/config/transcoding-temp
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:emby.{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=8096"
      - "traefik.tor.frontend.rule=Host:emby.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=8096"

  # Financial Tracker
  firefly_iii_app:
    restart: always
    environment:
      - FF_DB_HOST=firefly_iii_db
      - FF_DB_NAME=firefly_db
      - FF_DB_USER=firefly_db
      - FF_DB_PASSWORD=firefly_db_secret
      - FF_APP_KEY=S0m3R@nd0mStr1ngOf31Ch@rsEx@ctly
      - FF_APP_ENV=local
      - APP_URL=https://money.{{ domain }}
      - TZ={{ timezone }}
      - ServerName=money.{{ domain }}
    image: jc5x/firefly-iii
    links:
      - firefly_iii_db
    volumes:
      - /var/homelabos/firefly/export:/var/www/firefly-iii/storage/export
      - /var/homelabos/firefly/upload:/var/www/firefly-iii/storage/upload
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:money.{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=80"
      - "traefik.tor.frontend.rule=Host:money.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=80"

  firefly_iii_db:
    restart: always
    environment:
      - MYSQL_DATABASE=firefly_db
      - MYSQL_USER=firefly_db
      - MYSQL_PASSWORD=firefly_db_secret
      - MYSQL_RANDOM_ROOT_PASSWORD=yes
    image: mariadb
    volumes:
      - /var/homelabos/firefly/db:/var/lib/mysql

  # Code Hosting
  gitea:
    image: gitea/gitea:latest
    environment:
      - USER_UID=1000
      - USER_GID=1000
    restart: always
    links:
      - gitea_db:db
    volumes:
      - /var/lab/homelabos/gitea:/data
    ports:
      - "3030:3000"
      - "222:22"
    depends_on:
      - gitea_db
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:git.{{ domain }}"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM http://{{ domain }}"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM https://{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=3000"
      - "traefik.tor.frontend.rule=Host:git.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=3000"

  gitea_db:
    image: mariadb
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=gitea
      - MYSQL_USER=gitea
      - MYSQL_PASSWORD=gitea
      - MYSQL_DATABASE=gitea
    volumes:
      - /var/homelabos/gitea_db:/var/lib/mysql

  # Graphing
  grafana:
    image: grafana/grafana
    restart: always
    links:
      - influxdb
    volumes:
      - /var/homelabos/grafana:/var/lib/grafana
    environment:
      - GF_INSTALL_PLUGINS=grafana-clock-panel,natel-discrete-panel,petrslavotinek-carpetplot-panel,vonage-status-panel,raintank-worldping-app
      - GF_SMTP_ENABLED=true
      - GF_SMTP_HOST={{ smtp_host }}:{{ smtp_port }}
      - GF_SMTP_USER={{ smtp_user }}
      - GF_SMTP_PASSWORD={{ smtp_pass }}
      - GF_SMTP_FROM_ADDRESS={{ smtp_from_email }}
      - GF_SMTP_FROM_NAME={{ smtp_from_name }}
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:grafana.{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=3000"
      - "traefik.tor.frontend.rule=Host:grafana.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=3000"

  # Home Automation
  homeassistant:
    image: homeassistant/home-assistant
    volumes:
      - /var/homelabos/homeassistant:/config
      - /etc/localtime:/etc/localtime:ro
      - /etc/letsencrypt:/etc/letsencrypt
    restart: always
    ports:
      - 8123:8123
      - 1883:1883
      # - 8080:8080
      - 51827:51827
    links:
      - influxdb
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:homeassistant.{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=8123"
      - "traefik.tor.frontend.rule=Host:homeassistant.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=8123"

  # huginn:
  #   image: huginn/huginn
  #   links:
  #     - huginn_db:mysql
  #   ports:
  #     - 3132:3000
  #   environment:
  #     - HUGINN_DATABASE_NAME=huginn
  #     - HUGINN_DATABASE_USERNAME=huginn
  #     - HUGINN_DATABASE_PASSWORD=somethingsecret
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.frontend.rule=Host:huginn.{{ domain }}"
  #     - "traefik.http.protocol={{ protocol }}"
  #     - "traefik.http.port=3000"

  # huginn_db:
  #   image: mariadb
  #   restart: always
  #   volumes:
  #     - /var/homelabos/huginn_db:/var/lib/mysql
  #   environment:
  #     - MYSQL_ROOT_PASSWORD=huginn
  #     - MYSQL_PASSWORD=somethingsecret
  #     - MYSQL_DATABASE=huginn
  #     - MYSQL_USER=huginn

  # Time Series Data Store
  influxdb:
    image: influxdb
    restart: always
    volumes:
      - /var/homelabos/influxdb:/var/lib/influxdb
    ports:
      - 8086:8086

  # Torrent API
  jackett:
    image: linuxserver/jackett
    restart: always
    volumes: 
      - /var/homelabos/jackett/config:/config
      - /var/homelabos/jackett/downloads:/downloads
      - /etc/localtime:/etc/localtime:ro
    environment:
      - TZ={{ timezone }}
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:jackett.{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=9117"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM https://{{ domain }}"
      - "traefik.tor.frontend.rule=Host:jackett.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=9117"

  # kibitzr:
  #   image: peterdemin/kibitzr
  #   restart: always
  #   volumes:
  #     - /var/homelabos/kibitzr/config:/root/.config/kibitzr
  #     - /var/homelabos/kibitzr/pages:/pages 

  # Music Streamer
  koel:
    image: 0xcaff/koel
    restart: always
    links:
      - koel_database
    environment:
      DB_CONNECTION: mysql
      DB_HOST: koel_database
      DB_USERNAME: koel
      DB_PASSWORD: koel
      DB_DATABASE: koel
    volumes:
      - /mnt/nas/Music:/music
      - /var/homelabos/koel/covers:/var/www/html/public/img/covers
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:koel.{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=80"
      - "traefik.tor.frontend.rule=Host:koel.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=80"

  koel_database:
    image: mariadb
    restart: always
    volumes:
      - /var/homelabos/koel/db:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: koel
      MYSQL_USER: koel
      MYSQL_PASSWORD: koel

  # Web Analytics
  matomo_db:
    image: mariadb
    restart: always
    volumes:
      - /var/homelabos/matomo/db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=matomo
      - MYSQL_USER=matomo
      - MYSQL_PASSWORD=matomo
      - MYSQL_DATABASE=matomo

  matomo_app:
    image: crazymax/matomo:latest
    restart: always
    links:
      - matomo_db:db
    volumes:
      - /var/homelabos/matomo/data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:matomo.{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=80"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM http://{{ domain }}"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM https://{{ domain }}"
      - "traefik.tor.frontend.rule=Host:matomo.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=80"

  # RSS Reader
  miniflux:
    image: miniflux/miniflux:2.0.11
    restart: always
    links:
      - miniflux_db:db
    environment:
      - DATABASE_URL=postgres://miniflux:EsQMeV35CskJPE9eJwwqeV3ZFfZZ@db/miniflux?sslmode=disable
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:rss.{{ domain }}"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM http://{{ domain }}"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM https://{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=8080"
      - "traefik.tor.frontend.rule=Host:rss.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=80"

  miniflux_db:
    image: postgres:10.1
    restart: always
    environment:
      - POSTGRES_USER=miniflux
      - POSTGRES_PASSWORD=EsQMeV35CskJPE9eJwwqeV3ZFfZZ
    volumes:
      - /var/homelabos/miniflux/db:/var/lib/postgresql/data

  # S3 Storage for Backups via Restic
  minio:
    image: minio/minio
    restart: always
    command: server /data
    volumes:
      - /mnt/nas/Backups/minio:/data
      - /var/homelabos/minio/config:/root/.minio/
    ports:
      - 9110:9000
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:minio.{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=9000"
      - "traefik.tor.frontend.rule=Host:minio.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=9000"

  # Personal Relationship Database
  monicahq:
    image: monicahq/monicahq
    restart: always
    links:
      - monicahq_db
    ports:
      - 8176:80
    volumes:
      - /var/homelabos/monica/storage/app/public:/var/www/monica/storage/app/public
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:monica.{{ domain }}"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM http://{{ domain }}"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM https://{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=80"
      - "traefik.tor.frontend.rule=Host:monica.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=80"
    env_file:
      - /var/homelabos/docker/monica.env

  monicahq_db:
    image: mariadb
    restart: always
    env_file:
      - /var/homelabos/docker/monica.env
    volumes:
      - /var/homelabos/monica/mysql:/var/lib/mysql

  # Calendar, Contact, and Photo Sync Server
  nextcloud:
    image: nextcloud
    restart: always
    links:
      - nextcloud_db
    volumes:
      - /var/homelabos/nextcloud:/var/www/html
      - /mnt/nas/Documents/Nextcloud:/var/www/html/data
    restart: always
    environment:
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=nextcloud
      - MYSQL_HOST=nextcloud_db
      - NEXTCLOUD_ADMIN_USER={{ default_username }}
      - NEXTCLOUD_ADMIN_PASSWORD={{ default_password }}
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:nextcloud.{{ domain }}"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM http://{{ domain }}"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM https://{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=80"
      - "traefik.tor.frontend.rule=Host:nextcloud.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=80"

  nextcloud_db:
    image: mariadb
    restart: always
    volumes:
      - /var/homelabos/nextcloud_db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=nextcloud
      - MYSQL_PASSWORD=nextcloud
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud

  # Usenet Downloader
  nzbget:
    image: linuxserver/nzbget
    restart: always
    ports:
      - 6789:6789
    environment:
      - TZ={{ timezone }}
    volumes:
      - /var/homelabos/nzbget:/config
      - /mnt/nas/Downloads:/downloads
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:nzbget.{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=6789"

  # VPN Access
  openvpn:
    cap_add:
     - NET_ADMIN
    image: kylemanna/openvpn
    ports:
     - "1194:1194/udp"
    restart: always
    volumes:
     - /var/homelabos/openvpn:/etc/openvpn

  # Dashboard
  organizr:
    image: organizrtools/organizr-v2:php-fpm
    restart: always
    ports:
      - 8083:80
    volumes:
      - /var/homelabos/organizr:/config
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=80"
      - "traefik.tor.frontend.rule=Host:{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=80"

  # Document Storage
  paperless:
    image: danielquinn/paperless
    restart: always
    ports:
      - "8325:8000"
    healthcheck:
      test: ["CMD", "curl" , "-f", "http://localhost:8000"]
      interval: 30s
      timeout: 10s
      retries: 5
    volumes:
      - /var/homelabos/paperless/data:/usr/src/paperless/data
      - /var/homelabos/paperless/media:/usr/src/paperless/media
      - /mnt/nas/Documents/consume:/consume
      - /mnt/nas/Documents/export:/export
    environment:
      - PAPERLESS_OCR_LANGUAGES=
      - PAPERLESS_PASSPHRASE=homelabos
    command: ["runserver", "--insecure", "--noreload", "0.0.0.0:8000"]
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:paperless.{{ domain }}"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM http://{{ domain }}"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM https://{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=8000"
      - "traefik.tor.frontend.rule=Host:paperless.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=8000"

  paperless_consumer:
    image: danielquinn/paperless
    restart: always
    depends_on:
      - paperless
    volumes:
      - /var/homelabos/paperless/data:/usr/src/paperless/data
      - /var/homelabos/paperless/media:/usr/src/paperless/media
      - /mnt/nas/Documents/consume:/consume
      - /mnt/nas/Documents/export:/export
    environment:
      - PAPERLESS_PASSPHRASE=homelabos
    command: ["document_consumer"]

  # photoprism: # change if needed
  #   image: photoprism/photoprism # use pre-built image from docker hub: https://hub.docker.com/r/photoprism/photoprism/
  #   restart: always
  #   ports:
  #     - 2342:80 # left side is your local port (change if port 2342 is already used or you want to use port 80)
  #   volumes:
  #     - ~/Photos:/Photos # change ~/Photos to whatever directory you want to use on your local computer
  #     - photoprism-thumbnails:/var/photoprism/thumbnails # keep this (thumbnail cache)
  #   environment:
  #     PHOTOPRISM_IMPORT_PATH: "/Photos/Import" # ~/Photos/Import (files to be imported to originals)
  #     PHOTOPRISM_EXPORT_PATH: "/Photos/Export" # ~/Photos/Export (files exported from originals)
  #     PHOTOPRISM_ORIGINALS_PATH: "/Photos/Originals" # ~/Photos/Originals (original jpeg, raw and meta files)

  # database: # keep this
  #   image: mysql:latest
  #   restart: always
  #   command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --max-connections=1024
  #   volumes:
  #     - photoprism-database:/var/lib/mysql
  #   environment:
  #     MYSQL_ROOT_PASSWORD: photoprism
  #     MYSQL_USER: photoprism
  #     MYSQL_PASSWORD: photoprism
  #     MYSQL_DATABASE: photoprism

  # Network level ad blocking
  pihole:
    image: pihole/pihole:latest
    restart: always
    volumes:
      - /var/homelabos/pihole/config/:/etc/pihole/
      - /var/homelabos/pihole/dnsmasq.d/:/etc/dnsmasq.d/
    environment:
      - WEBPASSWORD={{ default_password }}
      - VIRTUAL_HOST=pihole.{{ domain }}
      - ServerIP={{ ansible_ssh_host }}
    # ports:
    #   - 53:53/tcp
    #   - 53:53/udp
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:pihole.{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=80"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM https://{{ domain }}"
      - "traefik.tor.frontend.rule=Host:pihole.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=80"
    extra_hosts:
      - docker.{{ domain }}:{{ ansible_ssh_host }}
      - docs.{{ domain }}:{{ ansible_ssh_host }}
      - emby.{{ domain }}:{{ ansible_ssh_host }}
      - git.{{ domain }}:{{ ansible_ssh_host }}
      - grafana.{{ domain }}:{{ ansible_ssh_host }}
      - homeassistant.{{ domain }}:{{ ansible_ssh_host }}
      - irc.{{ domain }}:{{ ansible_ssh_host }}
      - koel.{{ domain }}:{{ ansible_ssh_host }}
      - matomo.{{ domain }}:{{ ansible_ssh_host }}
      - mastodon.{{ domain }}:{{ ansible_ssh_host }}
      - minio.{{ domain }}:{{ ansible_ssh_host }}
      - money.{{ domain }}:{{ ansible_ssh_host }}
      - monica.{{ domain }}:{{ ansible_ssh_host }}
      - music.{{ domain }}:{{ ansible_ssh_host }}
      - nextcloud.{{ domain }}:{{ ansible_ssh_host }}
      - paperless.{{ domain }}:{{ ansible_ssh_host }}
      - pihole.{{ domain }}:{{ ansible_ssh_host }}
      - portainer.{{ domain }}:{{ ansible_ssh_host }}
      - radarr.{{ domain }}:{{ ansible_ssh_host }}
      - terminal.{{ domain }}:{{ ansible_ssh_host }}
      - torrent.{{ domain }}:{{ ansible_ssh_host }}
      - warden.{{ domain }}:{{ ansible_ssh_host }}

  # Docker Control
  portainer:
    image: portainer/portainer
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/homelabos/portainer:/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:docker.{{ domain }}"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM https://{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=9000"
      - "traefik.tor.frontend.rule=Host:docker.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=9000"

  # Movie Downloader
  radarr:
    image: linuxserver/radarr
    restart: always
    environment:
      - PGID=1000
      - PUID=1000
      - TZ={{ timezone }}
    links:
      - jackett
      - transmission
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/homelabos/radarr/config:/config
      - /mnt/nas/Movies:/movies
      - /mnt/nas/Downloads/completed:/downloads
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:radarr.{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=7878"
      - "traefik.tor.frontend.rule=Host:radarr.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=7878"

  # Backups https://nickbusey.gitlab.io/HomelabOS/software/restic/
  restic:
    image: lobaro/restic-backup-docker:v1.0
    restart: always
    environment:
      - RESTIC_REPOSITORY={{ s3_path }}
      - AWS_ACCESS_KEY_ID={{ s3_access_key }}
      - AWS_SECRET_ACCESS_KEY={{ s3_secret_key }}
      - RESTIC_PASSWORD={{ s3_backup_password }}
      - BACKUP_CRON={{ s3_backup_cron }}
      - HOSTNAME={{ domain }}
      - RESTIC_JOB_ARGS="--exclude=minio"
      - RESTIC_FORGET_ARGS="--prune --keep-last 10 --keep-hourly 24 --keep-daily 7 --keep-weekly 52 --keep-monthly 120 --keep-yearly 100"
    links:
      - minio
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/homelabos:/data:ro

  # TV Downloader
  sonarr:
    image: linuxserver/sonarr
    restart: always
    environment:
      - PGID=1000
      - PUID=1000
      - TZ={{ timezone }}
    links:
      - jackett
      - transmission
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/homelabos/sonarr/config:/config
      - /mnt/nas/TV:/tv
      - /var/homelabos/sonarr/downloads:/downloads
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:sonarr.{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=8989"
      - "traefik.tor.frontend.rule=Host:sonarr.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=8989"

  # Sync Server
  syncthing:
    image: linuxserver/syncthing
    restart: always
    volumes:
      - /var/homelabos/syncthing:/config
      - /mnt/nas/Syncthing:/data
      - /mnt/nas:/nas
    environment:
      - PGID=1004
      - PUID=1000
    ports:
      - 22000:22000
      - 21027:21027/udp
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:sync.{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=8384"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM http://{{ domain }}"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM https://{{ domain }}"
      - "traefik.tor.frontend.rule=Host:sync.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=8384"

  # System Statistics Logger
  telegraf:
    image: telegraf
    restart: always
    volumes:
      - /var/homelabos/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf
      - /var/run/docker.sock:/var/run/docker.sock
      - /sys:/rootfs/sys:ro
      - /proc:/rootfs/proc:ro
      - /etc:/rootfs/etc:ro
      - /mnt/nas:/mnt/nas
    links:
      - influxdb

  # IRC Bouncer
  thelounge:
    image: linuxserver/thelounge
    volumes:
      - /var/homelabos/thelounge:/config
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:thelounge.{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=9000"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM http://{{ domain }}"
      - "traefik.http.frontend.headers.customFrameOptionsValue=ALLOW-FROM https://{{ domain }}"
      - "traefik.tor.frontend.rule=Host:thelounge.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=9000"

  # Load Balancer / SSL / Web Server
  traefik:
    image: traefik
    restart: always
    ports:
      - "80:80"
      - "443:443"
      - "8181:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/homelabos/traefik/traefik.toml:/traefik.toml
      - /var/homelabos/traefik/acme.json:/acme.json

  # Torrent Downloader https://nickbusey.gitlab.io/HomelabOS/software/transmission/
  transmission:
    image: haugene/transmission-openvpn
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    restart: always
    ports:
      - "9091:9091"
      - "8888:8888"
    dns:
      - 8.8.8.8
      - 8.8.4.4
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /mnt/nas/Downloads:/data
      - /mnt/nas/Downloads/watch:/data/watch
      - /mnt/nas/Movies:/movies
      - /mnt/nas/TV:/tv
    environment:
      - OPENVPN_PROVIDER=PIA
      - OPENVPN_USERNAME={{ openvpn_username }}
      - OPENVPN_PASSWORD={{ openvpn_password }}
      - OPENVPN_OPTS=--inactive 3600 --ping 10 --ping-exit 300
      - PGID=0
      - PUID=0
      - TZ={{ timezone }}
      - TRANSMISSION_RPC_AUTHENTICATION_REQUIRED=true
      # Password = `transmission`
      - TRANSMISSION_RPC_PASSWORD="{62b16db87b89a91dd49a5110a7cafc06d20eb4f2wtK6kqPj"
      - TRANSMISSION_RPC_USERNAME={{ default_username }}
      - TRANSMISSION_SPEED_LIMIT_UP=100
      - TRANSMISSION_SPEED_LIMIT_UP_ENABLED=true
      - TRANSMISSION_SPEED_LIMIT_DOWN=100
      - TRANSMISSION_SPEED_LIMIT_DOWN_ENABLED=true
      - TRANSMISSION_RATIO_LIMIT=2
      - TRANSMISSION_RATIO_LIMIT_ENABLED=true
    labels:
      - "traefik.enable=true"
      - "traefik.http.frontend.rule=Host:torrent.{{ domain }}"
      - "traefik.http.protocol={{ protocol }}"
      - "traefik.http.port=9091"
      - "traefik.tor.frontend.rule=Host:torrent.{{ tor_domain }}"
      - "traefik.tor.protocol={{ protocol }}"
      - "traefik.tor.port=9091"

  # Bandwidth Usage Logger
  xfinityusageinfluxdb:
    restart: unless-stopped
    image: nickbusey/xfinityusageinfluxdb
    links:
      - influxdb
    environment:
      - XFINITY_USER={{ xfinity_user }}
      - XFINITY_PASSWORD={{ xfinity_password }}
      - INFLUXDB_HOST=influxdb